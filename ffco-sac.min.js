/**
 * FriendFeed & Co (Stand Alone Complex)
 * @version 1.30
 * @copyright 2014, 2015 David Mzareulyan
 * @link https://github.com/davidmz/friendfeed-and-co
 * @license MIT
 */
!function(){var e="1.30",t=function(){function t(e){return Array.prototype.slice.call(e)}function n(e,t,a){a=a||!1;var r=a?e:e.parentNode;return r&&r.nodeType==Node.ELEMENT_NODE?r.matches(t)?r:n(r,t):null}function a(){return o?e+" (SAC)":chrome.runtime.getManifest().version}function r(e){u.push(e)}var o="undefined"==typeof chrome||"undefined"==typeof chrome.runtime,i=o?document.currentScript.src.replace(/[a-z.-]+\.js([?#]|$)/,""):null;if(o){!function(){var e=i+"content.css",t=document.createElement("link");t.setAttribute("rel","stylesheet"),t.setAttribute("type","text/css"),t.setAttribute("href",e),document.head.appendChild(t)}();var c={reqId:0,callbacks:{},origin:"",win:null},s=new Promise(function(e){var t=i.replace(/^.*?\/\//,"");c.origin=location.protocol+"//"+t.replace(/\/.*/,"");var n=location.protocol+"//"+t+"messenger.html",a=function(){var t=document.body.appendChild(document.createElement("iframe"));t.style.display="none",t.src=n,t.addEventListener("load",function(){c.win=t.contentWindow,e(c)})};"complete"===document.readyState||"interactive"===document.readyState?a():document.addEventListener("DOMContentLoaded",a)});window.addEventListener("message",function(e){e.origin==c.origin&&e.data&&"reqId"in e.data&&e.data.reqId in c.callbacks&&(c.callbacks[e.data.reqId](e.data),delete c.callbacks[e.data.reqId])});var l=function(e){return new Promise(function(t){s.then(function(n){e.reqId=++n.reqId,n.callbacks[n.reqId]=t,n.win.postMessage(e,n.origin)})})}}var d,m=new Promise(function(e){var t=["fixNames","replyLinks","openImages","lightBoxedImages","killDuck","withAvatars","highlightRefComments","highlightAuthorComments","newLines"],n={};t.forEach(function(e){n[e]=!0}),n.withAvatars=!1,o?l({action:"get",key:"ffc-sac-settings"}).then(function(a){var r={};try{r=JSON.parse(a.resp)}catch(o){}t.forEach(function(e){e in r&&(n[e]=r[e])}),e(n)}):chrome.storage.sync.get("settings",function(a){if(a&&"settings"in a){var r=a.settings;t.forEach(function(e){e in r&&(n[e]=r[e])})}e(n)})}),u=[],f=new MutationObserver(function(e){e.forEach(function(e){0!=e.addedNodes.length&&t(e.addedNodes).forEach(function(e){e.nodeType==Node.ELEMENT_NODE&&u.forEach(function(t){t(e)})})})});m.then(function(e){d=e,u.forEach(function(e){e()}),f.observe(document.body,{childList:!0,subtree:!0})}),r(function(e){if(void 0===e){var t=document.createElement("DIV");t.className="box",t.innerHTML='<div class="box-bar ffnco">\n    <div class="box-corner"></div>\n    <div class="box-bar-text">&nbsp;</div>\n</div>\n<div class="box-body">\n    <ul>\n        <li>\n            <a href="#">Настройки FF&amp;Co</a>\n            <div class="updated">v {{VERSION}}</div>\n        </li>\n    </ul>\n</div>\n<div class="box-bottom">\n    <div class="box-corner"></div>\n    <div class="box-spacer"></div>\n</div>\n        '.replace("{{VERSION}}",a()),t.querySelector("a").onclick=function(e){if(e.preventDefault(),o){var t=i+"options.html",n='<!--suppress HtmlUnknownTarget --><div class="light-box-shadow"><div class="light-box-container"><iframe src="{{URL}}" class="light-box-iframe" frameborder="0"></iframe></div></div>',a=document.querySelector(".frf-co-light-box");a.innerHTML=n.replace("{{URL}}",t)}else window.open(chrome.extension.getURL("options.html"))};var n=document.getElementById("sidebar");n&&n.appendChild(t)}}),r(function(e){d.fixNames&&(e=e||document.body,t(e.querySelectorAll(".content > .l_profile, .lbody > .l_profile, .name > .l_profile, .foaf > .l_profile")).forEach(function(e){var t=e.getAttribute("href").substr(1);e.innerHTML!=t&&(e.dataset.displayName=e.innerHTML,e.innerHTML=t)}),t(e.querySelectorAll("#popup .name > .l_profile")).forEach(function(e){var t=e.dataset.displayName;void 0!==t&&(e.innerHTML=e.dataset.displayName)}))}),r(function(e){d.openImages&&(e=e||document.body,t(e.querySelectorAll(".images.media a[href *= 'm.friendfeed-media.com']")).forEach(function(e){var t=/^http:\/\/m\.friendfeed-media\.com\/(.*)/.exec(e.href);t&&(e.dataset.imageSrc=e.href,e.href="http://rss2lj.net/ffimg#"+t[1])}))}),r(function(e){if(d.lightBoxedImages){if(void 0===e){var a=document.createElement("DIV");a.className="frf-co-light-box",document.body.appendChild(a);var r='<!--suppress HtmlUnknownTarget --><div class="light-box-shadow"><div class="light-box-container"><img src="{{URL}}" class="light-box-img"></div></div>';document.body.addEventListener("keyup",function(e){27==e.keyCode&&""!=a.innerHTML&&(a.innerHTML="")}),document.body.addEventListener("click",function(e){if(n(e.target,".light-box-shadow",!0))return void(a.innerHTML="");var t=n(e.target,".light-box-thumbnail",!0);t&&0==e.button&&(e.preventDefault(),a.innerHTML=r.replace("{{URL}}",t.dataset.imageSrc).replace("{{LINK}}",t.href),a.querySelector(".light-box-img").addEventListener("click",function(){window.open(t.href,"_blank")}))},!1)}e=e||document.body,t(e.querySelectorAll(".images.media a:not(.light-box-thumbnail)")).forEach(function(e){var t,n,a,r=e.querySelector("img");e.dataset.imageSrc?e.classList.add("light-box-thumbnail"):/\.(jpe?g|png|gif)/i.test(e.href)?(e.dataset.imageSrc=e.href,e.classList.add("light-box-thumbnail")):/^http:\/\/m\.friendfeed-media\.com\//.test(e.href)?(e.dataset.imageSrc=e.href,e.classList.add("light-box-thumbnail")):/^https?:\/\/www\.flickr\.com\/photos\//.test(e.href)?r&&/^https?:\/\/farm\d+\.static\.?flickr\.com\//.test(r.src)?(e.dataset.imageSrc=r.src.replace(/_.\.jpg$/,"_b.jpg"),e.classList.add("light-box-thumbnail")):(n=o?"//noembed.com/embed?url=":"https://www.flickr.com/services/oembed/?format=json&url=",a=o?"media_url":"url",t=new XMLHttpRequest,t.open("GET",n+encodeURIComponent(e.href)),t.responseType="json",t.onload=function(){e.dataset.imageSrc=this.response[a],e.classList.add("light-box-thumbnail")},t.send()):/^https?:\/\/instagram\.com\/p\//.test(e.href)?(n=o?"//noembed.com/embed?url=":"https://api.instagram.com/oembed?url=",a=o?"media_url":"thumbnail_url",t=new XMLHttpRequest,t.open("GET",n+encodeURIComponent(e.href)),t.responseType="json",t.onload=function(){e.dataset.imageSrc=this.response[a],e.classList.add("light-box-thumbnail")},t.send()):/^http:\/\/imgur\.com\//.test(e.href)?(e.dataset.imageSrc="http://i.imgur.com/"+e.href.match(/^http:\/\/imgur\.com\/(gallery\/)?([^#]+)/)[2]+".jpg",e.classList.add("light-box-thumbnail")):/^http:\/\/gyazo\.com\//.test(e.href)?(e.dataset.imageSrc="http://i.gyazo.com/"+e.href.match(/^http:\/\/gyazo\.com\/([^#]+)/)[1]+".png",e.classList.add("light-box-thumbnail")):/soup\.io\/asset/.test(r.src)&&(e.dataset.imageSrc=r.src.replace(/_400(\.\w+)$/,"$1"),e.classList.add("light-box-thumbnail"))})}}),r(function(e){d.killDuck&&void 0===e&&t(document.querySelectorAll('body > div[style*="duck"]')).forEach(function(e){e.style.width=0,e.style.height=0})}),function(){var e=null;r(function(r){if(d.replyLinks){if(void 0===r){var o=document.querySelector(".profile h1 a.name");o&&(e=o.getAttribute("href").substr(1)),document.body.addEventListener("click",a,!1)}if(r=r||document.body,r.matches(".comments > span > .comment")){var i=r.parentNode;i.parentNode.insertBefore(r,i),i.parentNode.removeChild(i)}t(r.querySelectorAll(".expandcomment")).forEach(function(e){e.style.counterIncrement="comment "+parseInt(e.querySelector("a").textContent)});for(var c;c=r.querySelector(".comments div.quote");){var s=n(c,".comments"),l=s.parentNode.querySelector(".body > .info > .date").href,m=e,u=s.parentNode.querySelectorAll(".ebody > .title > .name > .l_profile");u.length>0&&(m=u[u.length-1].getAttribute("href").substr(1)),t(s.querySelectorAll("div.quote")).forEach(function(e){var t=e.parentNode,n=t.getAttribute("id"),a=document.createElement("A");a.className=e.className,a.title=e.title,a.href=l+"#"+n;var r=t.querySelector(".l_profile:not(.user-link)"),o=null;r&&(o=r.getAttribute("href").substr(1),t.classList.add("comment-from-"+o)),o===m&&t.classList.add("comment-from-post-author"),t.dataset.author=o?o:"",t.insertBefore(a,e),t.removeChild(e)}),t(s.querySelectorAll(".comment .content")).forEach(function(e){for(var t=e.firstChild;t;){if(t.nodeType==Node.TEXT_NODE&&/\B@([a-z0-9_]+)/.test(t.nodeValue)){for(var n,a=/\B@([a-z0-9_]+)/g,r=t.nodeValue,o=document.createDocumentFragment(),i=0;null!==(n=a.exec(r));){var c=n[0],s=n[1],l=n.index;o.appendChild(document.createTextNode(r.substr(i,l-i))),i=l+c.length;var d=o.appendChild(document.createElement("a"));d.appendChild(document.createTextNode(c)),d.href="/"+s,d.className="l_profile user-link"}var m=o.appendChild(document.createTextNode(r.substr(i)));e.insertBefore(o,t),e.removeChild(t),t=m}t=t.nextSibling}e.normalize()})}}});var a=function(e){if(e.target.matches("a.quote")&&0==e.button){e.preventDefault();var t=null;if(e.metaKey||e.ctrlKey){for(var a=e.target.parentNode,r=1;;)if(a=a.nextElementSibling,a&&a.classList.contains("comment")&&!a.classList.contains("bottomcomment"))r++;else if(a&&a.classList.contains("hiddencomments"));else{if(!a||!a.classList.contains("expandcomment"))break;r+=parseInt(a.querySelector("a").textContent)}t=r>4?"^×"+r:new Array(r+1).join("^")}var o=e.target.parentNode.dataset.author,i=n(e.target,".body"),c=i.querySelector("textarea");if(!c){var s=i.querySelector(".l_comment");s&&(s.click(),c=i.querySelector("textarea"))}c&&(t?(c.value+=t+" ",e.shiftKey&&(c.value+="this")):o&&(c.value+="@"+o+" "),c.focus(),c.selectionStart=c.selectionEnd=c.value.length)}}}(),function(){r(function(r){if(d.replyLinks&&d.withAvatars){if(void 0===r){var i=document.head.appendChild(document.createElement("style"));i.type="text/css",i.title="avatars",e=i.sheet}r=r||document.body,t(r.querySelectorAll(".entry:not(.with-avatars)")).forEach(function(e){e.classList.add("with-avatars")}),t(r.querySelectorAll(".comments > .comment:not(.ffco-with-avatar) .quote")).forEach(function(e){var t=e.parentNode;t.classList.add("ffco-with-avatar");var r=t.dataset.author;!r||r in a||(a[r]=!0,o(r));var i=n(t,".entry:not(.with-avatars)");i&&i.classList.add("with-avatars")})}});var e=null,a={},o=function(t){var n=document.querySelector("a[href='/"+t+"']");if(n){var a=document.querySelector("img[src*='"+n.getAttribute("sid")+"']");if(a){var r=a.src.replace(/-(\w+)-(\d+)$/,"-small-$2");return void e.insertRule(".comment-from-"+t+" > .quote { background-image: url("+r+"); }",0)}}e.insertRule(".comment-from-"+t+" > .quote { background-image: url('//friendfeed-api.com/v2/picture/"+t+"?size=small'); }",0)}}(),function(){r(function(n){d.replyLinks&&d.highlightRefComments&&(n=n||document.body,t(n.querySelectorAll(".l_profile.user-link")).forEach(function(e){c(e,".comment-from-"+e.getAttribute("href").substr(1))}),t(n.querySelectorAll(".comment .content")).forEach(function(t){var n=t.firstChild;if(n&&n.nodeType==Node.TEXT_NODE&&/^\s+[↑^]+/.test(n.nodeValue)){for(var a,r=n.nodeValue;null!==(a=/^(\s+)([↑^]\u00d7(\d+)|[↑^]+)/.exec(r));){var o=void 0===a[3]?a[2].length:parseInt(a[3]),i=e(t.parentNode,o);if(i){t.insertBefore(document.createTextNode(a[1]),n);var s=document.createElement("span");s.className="ups",s.appendChild(document.createTextNode(a[2])),c(s,"#"+i.id),t.insertBefore(s,n)}else t.insertBefore(document.createTextNode(a[0]),n);r=r.substr(a[0].length)}t.insertBefore(document.createTextNode(r),n),t.removeChild(n),t.normalize()}}))});var e=function(e,t){for(var n=null;;)if(e=e.previousElementSibling,e&&e.classList.contains("comment")){if(t--,0==t){n=e;break}}else if(e&&e.classList.contains("hiddencomments"));else{if(!e||!e.classList.contains("expandcomment"))break;if(t-=parseInt(e.querySelector("a").textContent),0>=t)break}return n},a=function(e){var a;(a=e.target.dataset.hlSelector)&&t(n(e.target,".comments").querySelectorAll(".comment")).forEach(function(e){e.matches(a)?e.classList.add("highlighted"):e.classList.remove("highlighted")})},o=function(e){t(n(e.target,".comments").querySelectorAll(".comment.highlighted")).forEach(function(e){e.classList.remove("highlighted")})},i=function(e){location.hash=e.target.dataset.hlSelector},c=function(e,t){e.dataset.hlSelector||(e.dataset.hlSelector=t,e.addEventListener("mouseover",a),e.addEventListener("mouseout",o),"#"==t.charAt(0)&&e.addEventListener("click",i))}}(),r(function(e){d.highlightAuthorComments&&void 0===e&&document.body.classList.add("hl-authors-comments")}),function(){r(function(e){d.newLines&&(void 0===e&&(document.addEventListener("keypress",function(e){13==e.keyCode&&"TEXTAREA"===e.target.nodeName&&e.target.matches(".editentryform textarea, .commentform textarea, .sharebox textarea")&&(e.shiftKey?e.stopPropagation():e.target.value=e.target.value.replace(/^\n+/,"").replace(/\n+$/,"").replace(/\n/g," "))},!0),document.addEventListener("submit",function(e){var t=e.target.querySelector("textarea[name='body']");t&&t.matches(".editentryform textarea, .commentform textarea, .sharebox textarea")&&(t.value=t.value.replace(/^\n+/,"").replace(/\n+$/,"").replace(/\n/g," "))},!0)),e=e||document.body,t(e.querySelectorAll(".comment .content, .entry .text")).forEach(function(e){for(var t=e.firstChild,n=!1;t;){if(t.nodeType==Node.TEXT_NODE&&/\u2000/.test(t.nodeValue)){n=!0;var a=document.createDocumentFragment(),r=0;t.nodeValue.split(/[ \t]*\u2000[ \t]*/).forEach(function(e){r=""===e?r+1:0,r>1||(""!==e&&a.appendChild(document.createTextNode(e)),a.appendChild(document.createElement("br")))}),a.removeChild(a.lastChild),e.insertBefore(a,t);var o=t.previousSibling;e.removeChild(t),t=o}t=t.nextSibling}n&&e.normalize()}),t(e.querySelectorAll(".editentryform textarea, .commentform textarea, .sharebox textarea")).forEach(function(e){e.value=e.value.replace(/\u2000/g,"\n")}))})}()};"complete"===document.readyState||"interactive"===document.readyState?t():document.addEventListener("DOMContentLoaded",t)}();