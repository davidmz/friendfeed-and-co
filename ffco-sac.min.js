/**
 * FriendFeed & Co (Stand Alone Complex)
 * @version 1.37
 * @copyright 2014, 2015 David Mzareulyan
 * @link https://github.com/davidmz/friendfeed-and-co
 * @license MIT
 */
!function(){doIt=function(){function e(e){return Array.prototype.slice.call(e)}function t(e){return e.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")}function n(e,t){var n=document.createElement(e);if("object"==typeof t)for(var o in t)t.hasOwnProperty(o)&&n.setAttribute(o,t[o]);if(arguments.length>2)for(var a=2;a<arguments.length;a++){var r=arguments[a];r instanceof Node?n.appendChild(r):"string"==typeof r&&n.appendChild(document.createTextNode(r))}return n}function o(e,t,n){n=n||!1;var a=n?e:e.parentNode;return a&&a.nodeType==Node.ELEMENT_NODE?a.matches(t)?a:o(a,t):null}function a(e){v.push(e)}var r,i,c="1.37",s="undefined"!=typeof chrome&&"undefined"!=typeof chrome.extension,l=s?null:document.currentScript.src.replace(/[a-z.-]+\.js([?#]|$)/,""),d=function(e){var t=["fixNames","replyLinks","openImages","lightBoxedImages","killDuck","withAvatars","highlightRefComments","highlightAuthorComments","newLines","markLinks"];e=e||{};var n={};return t.forEach(function(t){n[t]=t in e?e[t]:"withAvatars"!==t}),n},u=new Promise(function(e){"complete"===document.readyState||"interactive"===document.readyState?setTimeout(e,0):document.addEventListener("DOMContentLoaded",e)}),m={init:function(){},loadSettings:function(){return new Promise(function(e){var t;chrome.storage.sync.get("settings",function(n){t=n&&"settings"in n?d(n.settings):d(),e(t)})})},saveSettings:function(e){return new Promise(function(t){chrome.storage.sync.set({settings:e},t)})}},f={init:function(){var e=this;window.addEventListener("message",function(t){if("action"in t.data&&"getSettings"===t.data.action&&e.loadSettings().then(function(e){t.source.postMessage(e,t.origin)}),"action"in t.data&&"saveSettings"===t.data.action&&e.saveSettings(t.data.value),"action"in t.data&&"checkUpdates"===t.data.action){var n=Date.now();localStorage["ffc-sac-next-update"]=n+36e5;var o=new XMLHttpRequest;o.open("GET","https://rawgit.com/davidmz/friendfeed-and-co/master/manifest.json"),o.onload=function(){try{var e=JSON.parse(this.response);"version"in e&&(localStorage["ffc-sac-version"]=e.version,localStorage["ffc-sac-next-update"]=n+864e5,alert(e.version!=c?"Доступна новая версия: "+e.version+". Она будет установлена после перезагрузки страницы.":"У вас установлена последняя версия"))}catch(t){}},o.send()}})},loadSettings:function(){return new Promise(function(e){var t;try{t=d(JSON.parse(localStorage["ffc-sac-settings"]))}catch(n){t=d()}e(t)})},saveSettings:function(e){return localStorage["ffc-sac-settings"]=JSON.stringify(e),new Promise(function(e){setTimeout(e,0)})}},h={init:function(){var e=this;this.loadResolver=null,this.parentOrigin=location.protocol+"//friendfeed.com",window.addEventListener("message",function(t){t.origin===e.parentOrigin&&null!==e.loadResolver&&(e.loadResolver(d(t.data)),e.loadResolver=null)})},loadSettings:function(){var e=this;return new Promise(function(t){e.loadResolver=t,window.parent.postMessage({action:"getSettings",value:null},e.parentOrigin)})},saveSettings:function(e){var t=this;return new Promise(function(n){window.parent.postMessage({action:"saveSettings",value:e},t.parentOrigin),setTimeout(n,0)})}},p={init:function(){},loadSettings:function(){return new Promise(function(e){setTimeout(function(){e(d())},0)})},saveSettings:function(){return new Promise(function(e){setTimeout(e,0)})}},v=[],g=new MutationObserver(function(t){t.forEach(function(t){0!=t.addedNodes.length&&e(t.addedNodes).forEach(function(e){e.nodeType==Node.ELEMENT_NODE&&v.forEach(function(t){t(e)})})})});s?i=m:"friendfeed.com"===location.hostname?(i=f,u.then(function(){var e=l+"content.css",t=document.createElement("link");t.setAttribute("rel","stylesheet"),t.setAttribute("type","text/css"),t.setAttribute("href",e),document.head.appendChild(t)})):i=window.parent?h:p,!s&&"ffc-sac-version"in localStorage&&(c=localStorage["ffc-sac-version"]),u.then(function(){i.init(),i.loadSettings().then(function(e){r=e,v.forEach(function(e){e()}),g.observe(document.body,{childList:!0,subtree:!0})})}),a(function(e){if(void 0===e){var t=document.createElement("DIV");t.className="box",t.innerHTML='<div class="box-bar ffnco">\n    <div class="box-corner"></div>\n    <div class="box-bar-text">&nbsp;</div>\n</div>\n<div class="box-body">\n    <ul>\n        <li>\n            <a href="#">Настройки FF&amp;Co</a>\n            <div class="updated">v {{VERSION}}</div>\n        </li>\n    </ul>\n</div>\n<div class="box-bottom">\n    <div class="box-corner"></div>\n    <div class="box-spacer"></div>\n</div>\n        '.replace("{{VERSION}}",c),t.querySelector("a").onclick=function(e){if(e.preventDefault(),s)window.open(chrome.extension.getURL("options.html"));else{var t=l+"options.html",n='<!--suppress HtmlUnknownTarget --><div class="light-box-shadow"><div class="light-box-container"><iframe src="{{URL}}" class="light-box-iframe" frameborder="0"></iframe></div></div>',o=document.querySelector(".frf-co-light-box");o.innerHTML=n.replace("{{URL}}",t)}};var n=document.getElementById("sidebar");n&&n.appendChild(t)}}),a(function(t){r.fixNames&&(t=t||document.body,e(t.querySelectorAll(".content > .l_profile, .lbody > .l_profile, .name > .l_profile, .foaf > .l_profile")).forEach(function(e){var t=e.getAttribute("href").substr(1);e.innerHTML!=t&&(e.dataset.displayName=e.innerHTML,e.innerHTML=t)}),e(t.querySelectorAll("#popup .name > .l_profile")).forEach(function(e){var t=e.dataset.displayName;void 0!==t&&(e.innerHTML=e.dataset.displayName)}))}),a(function(t){r.openImages&&(t=t||document.body,e(t.querySelectorAll(".images.media a[href *= 'm.friendfeed-media.com']")).forEach(function(e){var t=/^http:\/\/m\.friendfeed-media\.com\/(.*)/.exec(e.href);t&&(e.dataset.imageSrc=e.href,e.href="http://rss2lj.net/ffimg#"+t[1])}))}),a(function(t){if(r.lightBoxedImages){if(void 0===t){var n=document.createElement("DIV");n.className="frf-co-light-box",document.body.appendChild(n);var a='<!--suppress HtmlUnknownTarget --><div class="light-box-shadow"><div class="light-box-container"><img src="{{URL}}" class="light-box-img"></div></div>';document.body.addEventListener("keyup",function(e){27==e.keyCode&&""!=n.innerHTML&&(n.innerHTML="")}),document.body.addEventListener("click",function(e){if(o(e.target,".light-box-shadow",!0))return void(n.innerHTML="");var t=o(e.target,".light-box-thumbnail",!0);t&&0==e.button&&(e.preventDefault(),n.innerHTML=a.replace("{{URL}}",t.dataset.imageSrc).replace("{{LINK}}",t.href),n.querySelector(".light-box-img").addEventListener("click",function(){window.open(t.href,"_blank")}))},!1)}var i=function(e){var t=new XMLHttpRequest;t.open("GET","https://noembed.com/embed?url="+encodeURIComponent(e.href)),t.responseType="json",t.onload=function(){e.dataset.imageSrc=this.response.media_url,e.classList.add("light-box-thumbnail")},t.send()};t=t||document.body,e(t.querySelectorAll(".images.media a:not(.light-box-thumbnail)")).forEach(function(e){var t=e.querySelector("img");e.dataset.imageSrc?e.classList.add("light-box-thumbnail"):/\.(jpe?g|png|gif)/i.test(e.href)?(e.dataset.imageSrc=e.href,e.classList.add("light-box-thumbnail")):/^http:\/\/m\.friendfeed-media\.com\//.test(e.href)?(e.dataset.imageSrc=e.href,e.classList.add("light-box-thumbnail")):/^https?:\/\/www\.flickr\.com\/photos\//.test(e.href)?t&&/^https?:\/\/farm\d+\.static\.?flickr\.com\//.test(t.src)?(e.dataset.imageSrc=t.src.replace(/_.\.jpg$/,"_b.jpg"),e.classList.add("light-box-thumbnail")):i(e):/^https?:\/\/instagram\.com\/p\//.test(e.href)?i(e):/^http:\/\/imgur\.com\//.test(e.href)?(e.dataset.imageSrc="http://i.imgur.com/"+e.href.match(/^http:\/\/imgur\.com\/(gallery\/)?([^#]+)/)[2]+".jpg",e.classList.add("light-box-thumbnail")):/^http:\/\/gyazo\.com\//.test(e.href)?(e.dataset.imageSrc="http://i.gyazo.com/"+e.href.match(/^http:\/\/gyazo\.com\/([^#]+)/)[1]+".png",e.classList.add("light-box-thumbnail")):/soup\.io\/asset/.test(t.src)&&(e.dataset.imageSrc=t.src.replace(/_400(\.\w+)$/,"$1"),e.classList.add("light-box-thumbnail"))})}}),a(function(t){r.killDuck&&void 0===t&&e(document.querySelectorAll('body > div[style*="duck"]')).forEach(function(e){e.style.width=0,e.style.height=0})}),function(){var t=null;a(function(a){if(r.replyLinks){if(void 0===a){var i=document.querySelector(".profile h1 a.name");i&&(t=i.getAttribute("href").substr(1)),document.body.addEventListener("click",n,!1)}if(a=a||document.body,a.matches(".comments > span > .comment")){var c=a.parentNode;c.parentNode.insertBefore(a,c),c.parentNode.removeChild(c)}e(a.querySelectorAll(".expandcomment")).forEach(function(e){e.style.counterIncrement="comment "+parseInt(e.querySelector("a").textContent)});for(var s;s=a.querySelector(".comments div.quote");){var l=o(s,".comments"),d=l.parentNode.querySelector(".body > .info > .date").href,u=t,m=l.parentNode.querySelectorAll(".ebody > .title > .name > .l_profile");m.length>0&&(u=m[m.length-1].getAttribute("href").substr(1)),e(l.querySelectorAll("div.quote")).forEach(function(e){var t=e.parentNode,n=t.getAttribute("id"),o=document.createElement("A");o.className=e.className,o.title=e.title,o.href=d+"#"+n;var a=t.querySelector(".l_profile:not(.user-link)"),r=null;a&&(r=a.getAttribute("href").substr(1),t.classList.add("comment-from-"+r)),r===u&&t.classList.add("comment-from-post-author"),t.dataset.author=r?r:"",t.insertBefore(o,e),t.removeChild(e)}),e(l.querySelectorAll(".comment .content")).forEach(function(e){for(var t=e.firstChild;t;){if(t.nodeType==Node.TEXT_NODE&&/\B@([a-z0-9_]+)/.test(t.nodeValue)){for(var n,o=/\B@([a-z0-9_]+)/g,a=t.nodeValue,r=document.createDocumentFragment(),i=0;null!==(n=o.exec(a));){var c=n[0],s=n[1],l=n.index;r.appendChild(document.createTextNode(a.substr(i,l-i))),i=l+c.length;var d=r.appendChild(document.createElement("a"));d.appendChild(document.createTextNode(c)),d.href="/"+s,d.className="l_profile user-link"}var u=r.appendChild(document.createTextNode(a.substr(i)));e.insertBefore(r,t),e.removeChild(t),t=u}t=t.nextSibling}e.normalize()})}}});var n=function(e){if(e.target.matches("a.quote")&&0==e.button){e.preventDefault();var t=null;if(e.metaKey||e.ctrlKey){for(var n=e.target.parentNode,a=1;;)if(n=n.nextElementSibling,n&&n.classList.contains("comment")&&!n.classList.contains("bottomcomment"))a++;else if(n&&n.classList.contains("hiddencomments"));else{if(!n||!n.classList.contains("expandcomment"))break;a+=parseInt(n.querySelector("a").textContent)}t=a>4?"^×"+a:new Array(a+1).join("^")}var r=e.target.parentNode.dataset.author,i=o(e.target,".body"),c=i.querySelector("textarea");if(!c){var s=i.querySelector(".l_comment");s&&(s.click(),c=i.querySelector("textarea"))}c&&(t?(c.value+=t+" ",e.shiftKey&&(c.value+="this")):r&&(c.value+="@"+r+" "),c.focus(),c.selectionStart=c.selectionEnd=c.value.length)}}}(),function(){a(function(a){if(r.replyLinks&&r.withAvatars){if(void 0===a){var c=document.head.appendChild(document.createElement("style"));c.type="text/css",c.title="avatars",t=c.sheet}a=a||document.body,e(a.querySelectorAll(".entry:not(.with-avatars)")).forEach(function(e){e.classList.add("with-avatars")}),e(a.querySelectorAll(".comments > .comment:not(.ffco-with-avatar) .quote")).forEach(function(e){var t=e.parentNode;t.classList.add("ffco-with-avatar");var a=t.dataset.author;!a||a in n||(n[a]=!0,i(a));var r=o(t,".entry:not(.with-avatars)");r&&r.classList.add("with-avatars")})}});var t=null,n={},i=function(e){var n=document.querySelector("a[href='/"+e+"']");if(n){var o=document.querySelector("img[src*='"+n.getAttribute("sid")+"']");if(o){var a=o.src.replace(/-(\w+)-(\d+)$/,"-small-$2");return void t.insertRule(".comment-from-"+e+" > .quote { background-image: url("+a+"); }",0)}}t.insertRule(".comment-from-"+e+" > .quote { background-image: url('//friendfeed-api.com/v2/picture/"+e+"?size=small'); }",0)}}(),function(){a(function(n){r.replyLinks&&r.highlightRefComments&&(n=n||document.body,e(n.querySelectorAll(".l_profile.user-link")).forEach(function(e){s(e,".comment-from-"+e.getAttribute("href").substr(1))}),e(n.querySelectorAll(".comment .content")).forEach(function(e){var n=e.firstChild;if(n&&n.nodeType==Node.TEXT_NODE&&/^\s+[↑^]+/.test(n.nodeValue)){for(var o,a=n.nodeValue;null!==(o=/^(\s+)([↑^]\u00d7(\d+)|[↑^]+)/.exec(a));){var r=void 0===o[3]?o[2].length:parseInt(o[3]),i=t(e.parentNode,r);if(i){e.insertBefore(document.createTextNode(o[1]),n);var c=document.createElement("span");c.className="ups",c.appendChild(document.createTextNode(o[2])),s(c,"#"+i.id),e.insertBefore(c,n)}else e.insertBefore(document.createTextNode(o[0]),n);a=a.substr(o[0].length)}e.insertBefore(document.createTextNode(a),n),e.removeChild(n),e.normalize()}}))});var t=function(e,t){for(var n=null;;)if(e=e.previousElementSibling,e&&e.classList.contains("comment")){if(t--,0==t){n=e;break}}else if(e&&e.classList.contains("hiddencomments"));else{if(!e||!e.classList.contains("expandcomment"))break;if(t-=parseInt(e.querySelector("a").textContent),0>=t)break}return n},n=function(t){var n;(n=t.target.dataset.hlSelector)&&e(o(t.target,".comments").querySelectorAll(".comment")).forEach(function(e){e.matches(n)?e.classList.add("highlighted"):e.classList.remove("highlighted")})},i=function(t){e(o(t.target,".comments").querySelectorAll(".comment.highlighted")).forEach(function(e){e.classList.remove("highlighted")})},c=function(e){location.hash=e.target.dataset.hlSelector},s=function(e,t){e.dataset.hlSelector||(e.dataset.hlSelector=t,e.addEventListener("mouseover",n),e.addEventListener("mouseout",i),"#"==t.charAt(0)&&e.addEventListener("click",c))}}(),a(function(e){r.highlightAuthorComments&&void 0===e&&document.body.classList.add("hl-authors-comments")}),function(){a(function(t){r.newLines&&(void 0===t&&(document.addEventListener("keypress",function(e){13==e.keyCode&&"TEXTAREA"===e.target.nodeName&&e.target.matches(".editentryform textarea, .commentform textarea, .sharebox textarea")&&(e.shiftKey?e.stopPropagation():e.target.value=e.target.value.replace(/^\n+/,"").replace(/\n+$/,"").replace(/\n/g," "))},!0),document.addEventListener("submit",function(e){var t=e.target.querySelector("textarea[name='body']");t&&t.matches(".editentryform textarea, .commentform textarea, .sharebox textarea")&&(t.value=t.value.replace(/^\n+/,"").replace(/\n+$/,"").replace(/\n/g," "))},!0)),t=t||document.body,e(t.querySelectorAll(".comment .content, .entry .text")).forEach(function(e){for(var t=e.firstChild,n=!1,o=e.classList.contains("text"),a=o?/[\n\u2000]/:/\u2000/,r=o?/[ \t]*[\u2000\n][ \t]*/:/[ \t]*\u2000[ \t]*/;t;){if(t.nodeType==Node.TEXT_NODE&&a.test(t.nodeValue)){n=!0;var i=document.createDocumentFragment(),c=0;t.nodeValue.split(r).forEach(function(e){c=""===e?c+1:0,c>1||(""!==e&&i.appendChild(document.createTextNode(e)),i.appendChild(document.createElement("br")))}),i.removeChild(i.lastChild),e.insertBefore(i,t);var s=t.previousSibling;e.removeChild(t),t=s}t=t.nextSibling}n&&e.normalize()}),e(t.querySelectorAll(".editentryform textarea, .commentform textarea, .sharebox textarea")).forEach(function(e){e.value=e.value.replace(/\u2000/g,"\n")}))})}(),function(){a(function(t){r.markLinks&&(t=t||document.body,e(t.querySelectorAll(".comment .content a, .entry .text a")).forEach(function(e){var t,n=e.previousSibling,o=e.nextSibling;null!==n&&n.nodeType===Node.TEXT_NODE&&"]("===n.nodeValue.slice(-2)&&null!==o&&o.nodeType===Node.TEXT_NODE&&")"===o.nodeValue.slice(0,1)&&null!==(t=/\[(.+?)]\($/.exec(n.nodeValue))&&(e.innerHTML="",e.appendChild(document.createTextNode(t[1])),o.nodeValue=o.nodeValue.slice(1),n.nodeValue=n.nodeValue.slice(0,-t[0].length))}))})}(),function(){a(function(o){o=o||document.body,e(o.querySelectorAll(".entry .ebody")).forEach(function(o){var a=o.querySelectorAll(".media a.l_play");if(a.length>0)e(a).forEach(function(e){var n,o=e.getAttribute("play");-1!==o.indexOf("vimeo.com/moogaloop.swf?clip_id=")?(n=o.match(/moogaloop\.swf\?clip_id=(\d+)/)[1],e.setAttribute("play",'<iframe width="613" height="345" src="//player.vimeo.com/video/'+n+'?autoplay=1" frameborder="0" allowfullscreen></iframe>')):-1!==o.indexOf("youtube.com/v/")&&(n=o.match(/youtube.com\/v\/([^&]+)/)[1],e.setAttribute("play",'<iframe width="613" height="345" src="'+t("//www.youtube.com/v/"+encodeURIComponent(n)+"&autoplay=1&showsearch=0&ap=%2526fmt%3D18&fs=1")+'" frameborder="0" allowfullscreen></iframe>'))});else{var r=o.querySelectorAll(".text a:not([href^='http://friendfeed.com/search?q='])");if(1===r.length){var i,c,s=r[0];if(null!==(i=s.href.match(/^https?:\/\/vimeo\.com\/(\d+)/))){c=i[1];var l=new XMLHttpRequest;l.open("GET","https://vimeo.com/api/v2/video/"+c+".json"),l.responseType="json",l.onload=function(){var e=this.response[0];o.appendChild(n("div",{"class":"images media"},n("div",{"class":"container"},n("a",{rel:"nofollow",href:e.url,"class":"l_play",play:'<iframe width="613" height="345" src="//player.vimeo.com/video/'+c+'?autoplay=1" frameborder="0" allowfullscreen></iframe>'},n("img",{src:e.thumbnail_medium,"class":"thumbnail",style:"width:200px; height:150px",alt:e.title,title:e.title})),n("div",{"class":"l_play",style:"left:88px;top:63px"},n("img",{src:"/static/images/playbutton.png?v=e094",alt:"Play"})))))},l.send()}(null!==(i=s.href.match(/^https?:\/\/www\.youtube\.com\/watch.*[?&]v=([^&?#]+)/))||null!==(i=s.href.match(/^https?:\/\/youtu\.be\/([^&?#]+)/)))&&(c=i[1],o.appendChild(n("div",{"class":"images media"},n("div",{"class":"container"},n("a",{rel:"nofollow",href:s.href,"class":"l_play",play:'<iframe width="613" height="345" src="'+t("//www.youtube.com/v/"+encodeURIComponent(c)+"&autoplay=1&showsearch=0&ap=%2526fmt%3D18&fs=1")+'" frameborder="0" allowfullscreen></iframe>'},n("img",{src:"http://img.youtube.com/vi/"+c+"/default.jpg","class":"thumbnail",style:"width:130px; height:97px"})),n("div",{"class":"l_play",style:"left:53px;top:36px"},n("img",{src:"/static/images/playbutton.png?v=e094",alt:"Play"}))))))}}})})}()},"complete"===document.readyState||"interactive"===document.readyState?doIt():document.addEventListener("DOMContentLoaded",doIt)}();