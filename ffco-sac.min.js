/**
 * FriendFeed & Co (Stand Alone Complex)
 * @version 1.35
 * @copyright 2014, 2015 David Mzareulyan
 * @link https://github.com/davidmz/friendfeed-and-co
 * @license MIT
 */
!function(){doIt=function(){function e(e){return Array.prototype.slice.call(e)}function t(e,n,o){o=o||!1;var a=o?e:e.parentNode;return a&&a.nodeType==Node.ELEMENT_NODE?a.matches(n)?a:t(a,n):null}function n(e){h.push(e)}var o,a,r="1.35",i="undefined"!=typeof chrome&&"undefined"!=typeof chrome.extension,c=i?null:document.currentScript.src.replace(/[a-z.-]+\.js([?#]|$)/,""),s=function(e){var t=["fixNames","replyLinks","openImages","lightBoxedImages","killDuck","withAvatars","highlightRefComments","highlightAuthorComments","newLines","markLinks"];e=e||{};var n={};return t.forEach(function(t){n[t]=t in e?e[t]:"withAvatars"!==t}),n},l=new Promise(function(e){"complete"===document.readyState||"interactive"===document.readyState?setTimeout(e,0):document.addEventListener("DOMContentLoaded",e)}),d={init:function(){},loadSettings:function(){return new Promise(function(e){var t;chrome.storage.sync.get("settings",function(n){t=n&&"settings"in n?s(n.settings):s(),e(t)})})},saveSettings:function(e){return new Promise(function(t){chrome.storage.sync.set({settings:e},t)})}},u={init:function(){var e=this;window.addEventListener("message",function(t){"action"in t.data&&"getSettings"===t.data.action&&e.loadSettings().then(function(e){t.source.postMessage(e,t.origin)}),"action"in t.data&&"saveSettings"===t.data.action&&e.saveSettings(t.data.value)})},loadSettings:function(){return new Promise(function(e){var t;try{t=s(JSON.parse(localStorage["ffc-sac-settings"]))}catch(n){t=s()}e(t)})},saveSettings:function(e){return localStorage["ffc-sac-settings"]=JSON.stringify(e),new Promise(function(e){setTimeout(e,0)})}},m={init:function(){var e=this;this.loadResolver=null,this.parentOrigin=location.protocol+"//friendfeed.com",window.addEventListener("message",function(t){t.origin===e.parentOrigin&&null!==e.loadResolver&&(e.loadResolver(s(t.data)),e.loadResolver=null)})},loadSettings:function(){var e=this;return new Promise(function(t){e.loadResolver=t,window.parent.postMessage({action:"getSettings",value:null},e.parentOrigin)})},saveSettings:function(e){var t=this;return new Promise(function(n){window.parent.postMessage({action:"saveSettings",value:e},t.parentOrigin),setTimeout(n,0)})}},f={init:function(){},loadSettings:function(){return new Promise(function(e){setTimeout(function(){e(s())},0)})},saveSettings:function(){return new Promise(function(e){setTimeout(e,0)})}},h=[],g=new MutationObserver(function(t){t.forEach(function(t){0!=t.addedNodes.length&&e(t.addedNodes).forEach(function(e){e.nodeType==Node.ELEMENT_NODE&&h.forEach(function(t){t(e)})})})});i?a=d:"friendfeed.com"===location.hostname?(a=u,l.then(function(){var e=c+"content.css",t=document.createElement("link");t.setAttribute("rel","stylesheet"),t.setAttribute("type","text/css"),t.setAttribute("href",e),document.head.appendChild(t)})):a=window.parent?m:f,l.then(function(){a.init(),a.loadSettings().then(function(e){o=e,h.forEach(function(e){e()}),g.observe(document.body,{childList:!0,subtree:!0})})}),n(function(e){if(void 0===e){var t=document.createElement("DIV");t.className="box",t.innerHTML='<div class="box-bar ffnco">\n    <div class="box-corner"></div>\n    <div class="box-bar-text">&nbsp;</div>\n</div>\n<div class="box-body">\n    <ul>\n        <li>\n            <a href="#">Настройки FF&amp;Co</a>\n            <div class="updated">v {{VERSION}}</div>\n        </li>\n    </ul>\n</div>\n<div class="box-bottom">\n    <div class="box-corner"></div>\n    <div class="box-spacer"></div>\n</div>\n        '.replace("{{VERSION}}",r),t.querySelector("a").onclick=function(e){if(e.preventDefault(),i)window.open(chrome.extension.getURL("options.html"));else{var t=c+"options.html",n='<!--suppress HtmlUnknownTarget --><div class="light-box-shadow"><div class="light-box-container"><iframe src="{{URL}}" class="light-box-iframe" frameborder="0"></iframe></div></div>',o=document.querySelector(".frf-co-light-box");o.innerHTML=n.replace("{{URL}}",t)}};var n=document.getElementById("sidebar");n&&n.appendChild(t)}}),n(function(t){o.fixNames&&(t=t||document.body,e(t.querySelectorAll(".content > .l_profile, .lbody > .l_profile, .name > .l_profile, .foaf > .l_profile")).forEach(function(e){var t=e.getAttribute("href").substr(1);e.innerHTML!=t&&(e.dataset.displayName=e.innerHTML,e.innerHTML=t)}),e(t.querySelectorAll("#popup .name > .l_profile")).forEach(function(e){var t=e.dataset.displayName;void 0!==t&&(e.innerHTML=e.dataset.displayName)}))}),n(function(t){o.openImages&&(t=t||document.body,e(t.querySelectorAll(".images.media a[href *= 'm.friendfeed-media.com']")).forEach(function(e){var t=/^http:\/\/m\.friendfeed-media\.com\/(.*)/.exec(e.href);t&&(e.dataset.imageSrc=e.href,e.href="http://rss2lj.net/ffimg#"+t[1])}))}),n(function(n){if(o.lightBoxedImages){if(void 0===n){var a=document.createElement("DIV");a.className="frf-co-light-box",document.body.appendChild(a);var r='<!--suppress HtmlUnknownTarget --><div class="light-box-shadow"><div class="light-box-container"><img src="{{URL}}" class="light-box-img"></div></div>';document.body.addEventListener("keyup",function(e){27==e.keyCode&&""!=a.innerHTML&&(a.innerHTML="")}),document.body.addEventListener("click",function(e){if(t(e.target,".light-box-shadow",!0))return void(a.innerHTML="");var n=t(e.target,".light-box-thumbnail",!0);n&&0==e.button&&(e.preventDefault(),a.innerHTML=r.replace("{{URL}}",n.dataset.imageSrc).replace("{{LINK}}",n.href),a.querySelector(".light-box-img").addEventListener("click",function(){window.open(n.href,"_blank")}))},!1)}var i=function(e){var t=new XMLHttpRequest;t.open("GET","https://noembed.com/embed?url="+encodeURIComponent(e.href)),t.responseType="json",t.onload=function(){e.dataset.imageSrc=this.response.media_url,e.classList.add("light-box-thumbnail")},t.send()};n=n||document.body,e(n.querySelectorAll(".images.media a:not(.light-box-thumbnail)")).forEach(function(e){var t=e.querySelector("img");e.dataset.imageSrc?e.classList.add("light-box-thumbnail"):/\.(jpe?g|png|gif)/i.test(e.href)?(e.dataset.imageSrc=e.href,e.classList.add("light-box-thumbnail")):/^http:\/\/m\.friendfeed-media\.com\//.test(e.href)?(e.dataset.imageSrc=e.href,e.classList.add("light-box-thumbnail")):/^https?:\/\/www\.flickr\.com\/photos\//.test(e.href)?t&&/^https?:\/\/farm\d+\.static\.?flickr\.com\//.test(t.src)?(e.dataset.imageSrc=t.src.replace(/_.\.jpg$/,"_b.jpg"),e.classList.add("light-box-thumbnail")):i(e):/^https?:\/\/instagram\.com\/p\//.test(e.href)?i(e):/^http:\/\/imgur\.com\//.test(e.href)?(e.dataset.imageSrc="http://i.imgur.com/"+e.href.match(/^http:\/\/imgur\.com\/(gallery\/)?([^#]+)/)[2]+".jpg",e.classList.add("light-box-thumbnail")):/^http:\/\/gyazo\.com\//.test(e.href)?(e.dataset.imageSrc="http://i.gyazo.com/"+e.href.match(/^http:\/\/gyazo\.com\/([^#]+)/)[1]+".png",e.classList.add("light-box-thumbnail")):/soup\.io\/asset/.test(t.src)&&(e.dataset.imageSrc=t.src.replace(/_400(\.\w+)$/,"$1"),e.classList.add("light-box-thumbnail"))})}}),n(function(t){o.killDuck&&void 0===t&&e(document.querySelectorAll('body > div[style*="duck"]')).forEach(function(e){e.style.width=0,e.style.height=0})}),function(){var a=null;n(function(n){if(o.replyLinks){if(void 0===n){var i=document.querySelector(".profile h1 a.name");i&&(a=i.getAttribute("href").substr(1)),document.body.addEventListener("click",r,!1)}if(n=n||document.body,n.matches(".comments > span > .comment")){var c=n.parentNode;c.parentNode.insertBefore(n,c),c.parentNode.removeChild(c)}e(n.querySelectorAll(".expandcomment")).forEach(function(e){e.style.counterIncrement="comment "+parseInt(e.querySelector("a").textContent)});for(var s;s=n.querySelector(".comments div.quote");){var l=t(s,".comments"),d=l.parentNode.querySelector(".body > .info > .date").href,u=a,m=l.parentNode.querySelectorAll(".ebody > .title > .name > .l_profile");m.length>0&&(u=m[m.length-1].getAttribute("href").substr(1)),e(l.querySelectorAll("div.quote")).forEach(function(e){var t=e.parentNode,n=t.getAttribute("id"),o=document.createElement("A");o.className=e.className,o.title=e.title,o.href=d+"#"+n;var a=t.querySelector(".l_profile:not(.user-link)"),r=null;a&&(r=a.getAttribute("href").substr(1),t.classList.add("comment-from-"+r)),r===u&&t.classList.add("comment-from-post-author"),t.dataset.author=r?r:"",t.insertBefore(o,e),t.removeChild(e)}),e(l.querySelectorAll(".comment .content")).forEach(function(e){for(var t=e.firstChild;t;){if(t.nodeType==Node.TEXT_NODE&&/\B@([a-z0-9_]+)/.test(t.nodeValue)){for(var n,o=/\B@([a-z0-9_]+)/g,a=t.nodeValue,r=document.createDocumentFragment(),i=0;null!==(n=o.exec(a));){var c=n[0],s=n[1],l=n.index;r.appendChild(document.createTextNode(a.substr(i,l-i))),i=l+c.length;var d=r.appendChild(document.createElement("a"));d.appendChild(document.createTextNode(c)),d.href="/"+s,d.className="l_profile user-link"}var u=r.appendChild(document.createTextNode(a.substr(i)));e.insertBefore(r,t),e.removeChild(t),t=u}t=t.nextSibling}e.normalize()})}}});var r=function(e){if(e.target.matches("a.quote")&&0==e.button){e.preventDefault();var n=null;if(e.metaKey||e.ctrlKey){for(var o=e.target.parentNode,a=1;;)if(o=o.nextElementSibling,o&&o.classList.contains("comment")&&!o.classList.contains("bottomcomment"))a++;else if(o&&o.classList.contains("hiddencomments"));else{if(!o||!o.classList.contains("expandcomment"))break;a+=parseInt(o.querySelector("a").textContent)}n=a>4?"^×"+a:new Array(a+1).join("^")}var r=e.target.parentNode.dataset.author,i=t(e.target,".body"),c=i.querySelector("textarea");if(!c){var s=i.querySelector(".l_comment");s&&(s.click(),c=i.querySelector("textarea"))}c&&(n?(c.value+=n+" ",e.shiftKey&&(c.value+="this")):r&&(c.value+="@"+r+" "),c.focus(),c.selectionStart=c.selectionEnd=c.value.length)}}}(),function(){n(function(n){if(o.replyLinks&&o.withAvatars){if(void 0===n){var c=document.head.appendChild(document.createElement("style"));c.type="text/css",c.title="avatars",a=c.sheet}n=n||document.body,e(n.querySelectorAll(".entry:not(.with-avatars)")).forEach(function(e){e.classList.add("with-avatars")}),e(n.querySelectorAll(".comments > .comment:not(.ffco-with-avatar) .quote")).forEach(function(e){var n=e.parentNode;n.classList.add("ffco-with-avatar");var o=n.dataset.author;!o||o in r||(r[o]=!0,i(o));var a=t(n,".entry:not(.with-avatars)");a&&a.classList.add("with-avatars")})}});var a=null,r={},i=function(e){var t=document.querySelector("a[href='/"+e+"']");if(t){var n=document.querySelector("img[src*='"+t.getAttribute("sid")+"']");if(n){var o=n.src.replace(/-(\w+)-(\d+)$/,"-small-$2");return void a.insertRule(".comment-from-"+e+" > .quote { background-image: url("+o+"); }",0)}}a.insertRule(".comment-from-"+e+" > .quote { background-image: url('//friendfeed-api.com/v2/picture/"+e+"?size=small'); }",0)}}(),function(){n(function(t){o.replyLinks&&o.highlightRefComments&&(t=t||document.body,e(t.querySelectorAll(".l_profile.user-link")).forEach(function(e){s(e,".comment-from-"+e.getAttribute("href").substr(1))}),e(t.querySelectorAll(".comment .content")).forEach(function(e){var t=e.firstChild;if(t&&t.nodeType==Node.TEXT_NODE&&/^\s+[↑^]+/.test(t.nodeValue)){for(var n,o=t.nodeValue;null!==(n=/^(\s+)([↑^]\u00d7(\d+)|[↑^]+)/.exec(o));){var r=void 0===n[3]?n[2].length:parseInt(n[3]),i=a(e.parentNode,r);if(i){e.insertBefore(document.createTextNode(n[1]),t);var c=document.createElement("span");c.className="ups",c.appendChild(document.createTextNode(n[2])),s(c,"#"+i.id),e.insertBefore(c,t)}else e.insertBefore(document.createTextNode(n[0]),t);o=o.substr(n[0].length)}e.insertBefore(document.createTextNode(o),t),e.removeChild(t),e.normalize()}}))});var a=function(e,t){for(var n=null;;)if(e=e.previousElementSibling,e&&e.classList.contains("comment")){if(t--,0==t){n=e;break}}else if(e&&e.classList.contains("hiddencomments"));else{if(!e||!e.classList.contains("expandcomment"))break;if(t-=parseInt(e.querySelector("a").textContent),0>=t)break}return n},r=function(n){var o;(o=n.target.dataset.hlSelector)&&e(t(n.target,".comments").querySelectorAll(".comment")).forEach(function(e){e.matches(o)?e.classList.add("highlighted"):e.classList.remove("highlighted")})},i=function(n){e(t(n.target,".comments").querySelectorAll(".comment.highlighted")).forEach(function(e){e.classList.remove("highlighted")})},c=function(e){location.hash=e.target.dataset.hlSelector},s=function(e,t){e.dataset.hlSelector||(e.dataset.hlSelector=t,e.addEventListener("mouseover",r),e.addEventListener("mouseout",i),"#"==t.charAt(0)&&e.addEventListener("click",c))}}(),n(function(e){o.highlightAuthorComments&&void 0===e&&document.body.classList.add("hl-authors-comments")}),function(){n(function(t){o.newLines&&(void 0===t&&(document.addEventListener("keypress",function(e){13==e.keyCode&&"TEXTAREA"===e.target.nodeName&&e.target.matches(".editentryform textarea, .commentform textarea, .sharebox textarea")&&(e.shiftKey?e.stopPropagation():e.target.value=e.target.value.replace(/^\n+/,"").replace(/\n+$/,"").replace(/\n/g," "))},!0),document.addEventListener("submit",function(e){var t=e.target.querySelector("textarea[name='body']");t&&t.matches(".editentryform textarea, .commentform textarea, .sharebox textarea")&&(t.value=t.value.replace(/^\n+/,"").replace(/\n+$/,"").replace(/\n/g," "))},!0)),t=t||document.body,e(t.querySelectorAll(".comment .content, .entry .text")).forEach(function(e){for(var t=e.firstChild,n=!1;t;){if(t.nodeType==Node.TEXT_NODE&&/\u2000/.test(t.nodeValue)){n=!0;var o=document.createDocumentFragment(),a=0;t.nodeValue.split(/[ \t]*\u2000[ \t]*/).forEach(function(e){a=""===e?a+1:0,a>1||(""!==e&&o.appendChild(document.createTextNode(e)),o.appendChild(document.createElement("br")))}),o.removeChild(o.lastChild),e.insertBefore(o,t);var r=t.previousSibling;e.removeChild(t),t=r}t=t.nextSibling}n&&e.normalize()}),e(t.querySelectorAll(".editentryform textarea, .commentform textarea, .sharebox textarea")).forEach(function(e){e.value=e.value.replace(/\u2000/g,"\n")}))})}(),function(){n(function(t){o.markLinks&&(t=t||document.body,e(t.querySelectorAll(".comment .content a, .entry .text a")).forEach(function(e){var t,n=e.previousSibling,o=e.nextSibling;null!==n&&n.nodeType===Node.TEXT_NODE&&"]("===n.nodeValue.slice(-2)&&null!==o&&o.nodeType===Node.TEXT_NODE&&")"===o.nodeValue.slice(0,1)&&null!==(t=/\[(.+?)]\($/.exec(n.nodeValue))&&(e.innerHTML="",e.appendChild(document.createTextNode(t[1])),o.nodeValue=o.nodeValue.slice(1),n.nodeValue=n.nodeValue.slice(0,-t[0].length))}))})}()},"complete"===document.readyState||"interactive"===document.readyState?doIt():document.addEventListener("DOMContentLoaded",doIt)}();